/* CAMBIOS PARA ADMNISTRAR COORDINADORES DEPARTAMENTALES */
-- BUSCAR CONSTRAINT
ALTER TABLE TR_RESPUESTA_USUARIO_ENCUESTA
    DROP CONSTRAINT DF__TR_RESPUE__RESPU__336AA144;

ALTER TABLE TR_RESPUESTA_USUARIO_ENCUESTA
    ALTER COLUMN RESPUESTA_ABIERTA NVARCHAR(500) NULL
;

/* INICIO TABLA PARA COORDINADORES DEPARTAMENTALES DE TUTORIAS */
CREATE TABLE TR_COORDINADOR_DEPARTAMENTAL_TUTORIA
(
    PK_COORDINADOR          INT      NOT NULL IDENTITY (1,1),
    FK_USUARIO              INT      NOT NULL,
    FK_AREA_ACADEMICA       INT      NOT NULL,

    ESTADO                  SMALLINT NOT NULL DEFAULT 1,

    FK_USUARIO_REGISTRO     INT,
    FECHA_REGISTRO          DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FK_USUARIO_MODIFICACION INT,
    FECHA_MODIFICACION      DATETIME,
    BORRADO                 SMALLINT NOT NULL DEFAULT 0
);

ALTER TABLE TR_COORDINADOR_DEPARTAMENTAL_TUTORIA
    ADD CONSTRAINT PRK_COORDINADOR_TR_COORDINADOR_DEPARTAMENTAL_TUTORIA
        PRIMARY KEY (PK_COORDINADOR ASC);

ALTER TABLE TR_COORDINADOR_DEPARTAMENTAL_TUTORIA
    ADD CONSTRAINT FRK_USUARIO_TR_COORDINADOR_DEPARTAMENTAL_TUTORIA
        FOREIGN KEY (FK_USUARIO) REFERENCES CAT_USUARIO (PK_USUARIO);

ALTER TABLE TR_COORDINADOR_DEPARTAMENTAL_TUTORIA
    ADD CONSTRAINT FRK_DEPARTAMENTO_TR_COORDINADOR_DEPARTAMENTAL_TUTORIA
        FOREIGN KEY (FK_AREA_ACADEMICA) REFERENCES CAT_AREA_ACADEMICA (PK_AREA_ACADEMICA);
/* FIN TABLA PARA COORDINADORES DE TUTORIAS */

-- REGISTRO DE ROLES
INSERT INTO PER_CAT_ROL(FK_SISTEMA, NOMBRE, ABREVIATURA)
VALUES (1, 'Coordinador departamental', 'COORD_TUT');

INSERT INTO PER_CAT_ROL(FK_SISTEMA, NOMBRE, ABREVIATURA)
VALUES (1, 'Coordinador institucional', 'COORI_TUT');

INSERT INTO PER_CAT_ROL(FK_SISTEMA, NOMBRE, ABREVIATURA)
VALUES (1, 'Administrador', 'ADM_TUT');

 -- REGISTRO DE MÓDULOS
INSERT INTO PER_CAT_MODULO(NOMBRE, ESTADO, ORDEN)
VALUES ('Coordinadores institucionales', 1, 1);

INSERT INTO PER_CAT_MODULO(NOMBRE, ESTADO, ORDEN)
VALUES ('Coordinadores departamentales', 1, 1);

INSERT INTO PER_CAT_MODULO(NOMBRE, ESTADO, ORDEN)
VALUES ('Datos tutor', 1, 1);

INSERT INTO PER_CAT_MODULO(NOMBRE, ESTADO, ORDEN)
VALUES ('Usuarios', 1, 1);

INSERT INTO PER_CAT_MODULO(NOMBRE, ESTADO, ORDEN)
VALUES ('Horario', 1, 3);

INSERT INTO PER_CAT_MODULO(NOMBRE, ESTADO, ORDEN)
VALUES ('Seguimiento académico', 1, 4);

-- ASIGNACIÓN DE MÓDULOS A ROLES
INSERT INTO PER_TR_ROL_MODULO(FK_ROL, FK_MODULO)
VALUES (
   (SELECT PK_ROL FROM PER_CAT_ROL WHERE ABREVIATURA = 'EST_TUT'),
   (SELECT PK_MODULO FROM PER_CAT_MODULO WHERE NOMBRE = 'Datos tutor')
);

INSERT INTO PER_TR_ROL_MODULO(FK_ROL, FK_MODULO)
VALUES (
   (SELECT PK_ROL FROM PER_CAT_ROL WHERE ABREVIATURA = 'EST_TUT'),
   (SELECT PK_MODULO FROM PER_CAT_MODULO WHERE NOMBRE = 'Horario')
);

INSERT INTO PER_TR_ROL_MODULO(FK_ROL, FK_MODULO)
VALUES (
   (SELECT PK_ROL FROM PER_CAT_ROL WHERE ABREVIATURA = 'EST_TUT'),
   (SELECT PK_MODULO FROM PER_CAT_MODULO WHERE NOMBRE = 'Seguimiento académico')
);

INSERT INTO PER_TR_ROL_MODULO(FK_ROL, FK_MODULO)
VALUES (
   (SELECT PK_ROL FROM PER_CAT_ROL WHERE ABREVIATURA = 'ADM_TUT'),
   (SELECT PK_MODULO FROM PER_CAT_MODULO WHERE NOMBRE = 'Grupos')
);

INSERT INTO PER_TR_ROL_MODULO(FK_ROL, FK_MODULO)
VALUES (
   (SELECT PK_ROL FROM PER_CAT_ROL WHERE ABREVIATURA = 'COORI_TUT'),
   (SELECT PK_MODULO FROM PER_CAT_MODULO WHERE NOMBRE = 'Grupos')
);

INSERT INTO PER_TR_ROL_MODULO(FK_ROL, FK_MODULO)
VALUES (
   (SELECT PK_ROL FROM PER_CAT_ROL WHERE ABREVIATURA = 'ADM_TUT'),
   (SELECT PK_MODULO FROM PER_CAT_MODULO WHERE NOMBRE = 'Coordinadores institucionales')
);

INSERT INTO PER_TR_ROL_MODULO(FK_ROL, FK_MODULO)
VALUES (
   (SELECT PK_ROL FROM PER_CAT_ROL WHERE ABREVIATURA = 'ADM_TUT'),
   (SELECT PK_MODULO FROM PER_CAT_MODULO WHERE NOMBRE = 'Usuarios')
);

INSERT INTO PER_TR_ROL_MODULO(FK_ROL, FK_MODULO)
VALUES (
   (SELECT PK_ROL FROM PER_CAT_ROL WHERE ABREVIATURA = 'ADM_TUT'),
   (SELECT PK_MODULO FROM PER_CAT_MODULO WHERE NOMBRE = 'Coordinadores departamentales')
);

INSERT INTO PER_TR_ROL_MODULO(FK_ROL, FK_MODULO)
VALUES (
   (SELECT PK_ROL FROM PER_CAT_ROL WHERE ABREVIATURA = 'COORI_TUT'),
   (SELECT PK_MODULO FROM PER_CAT_MODULO WHERE NOMBRE = 'Coordinadores departamentales')
);


/* ************************ *
    * PRODUCCIÓN: PENDIENTE *
 * ************************ */

/* ASIGNACIÓN DE ROL A ADMINISTRADOR */
-- SIIA: 1501 NOMBRE: MARÍA ELENA	MARTINEZ	HERNÁNDEZ
INSERT INTO PER_TR_ROL_USUARIO(FK_ROL, FK_USUARIO)
VALUES (5, (SELECT PK_USUARIO FROM CAT_USUARIO WHERE NUMERO_CONTROL = '1501'));

UPDATE PER_CAT_SISTEMA SET NOMBRE = 'Tutorías' WHERE NOMBRE = 'tutorias';

/* INICIO TABLA PARA COORDINADORES INSTITUCIONALES DE TUTORIAS */
CREATE TABLE TR_COORDINADOR_INSTITUCIONAL_TUTORIA
(
    PK_COORDINADOR          INT      NOT NULL IDENTITY (1,1),
    FK_USUARIO              INT      NOT NULL,

    ESTADO                  SMALLINT NOT NULL DEFAULT 1,

    FK_USUARIO_REGISTRO     INT,
    FECHA_REGISTRO          DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FK_USUARIO_MODIFICACION INT,
    FECHA_MODIFICACION      DATETIME,
    BORRADO                 SMALLINT NOT NULL DEFAULT 0
);

ALTER TABLE TR_COORDINADOR_INSTITUCIONAL_TUTORIA
    ADD CONSTRAINT PRK_COORDINADOR_TR_COORDINADOR_INSTITUCIONAL_TUTORIA
        PRIMARY KEY (PK_COORDINADOR ASC);

ALTER TABLE TR_COORDINADOR_INSTITUCIONAL_TUTORIA
    ADD CONSTRAINT FRK_USUARIO_TR_COORDINADOR_INSTITUCIONAL_TUTORIA
        FOREIGN KEY (FK_USUARIO) REFERENCES CAT_USUARIO (PK_USUARIO);
/* FIN TABLA PARA COORDINADORES INSTITUCIONALES DE TUTORIAS */
