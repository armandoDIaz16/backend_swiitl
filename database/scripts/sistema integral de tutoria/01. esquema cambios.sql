/* VISTA PARA PROCESAR REPORTE DE DATOS PERSONALES */
DROP VIEW IF EXISTS VW_REPORTE_DATOS_PERSONALES;
CREATE VIEW VW_REPORTE_DATOS_PERSONALES AS
SELECT
    -- AREA ACADEMICA
    PK_AREA_ACADEMICA,
    CAT_AREA_ACADEMICA.NOMBRE AS AREA_ACADEMICA,
    -- CARRERA
    CAT_CARRERA.PK_CARRERA,
    CAT_CARRERA.NOMBRE AS CARRERA,
    -- GRUPO
    TR_GRUPO_TUTORIA.PK_GRUPO_TUTORIA,
    TR_GRUPO_TUTORIA.CLAVE,
    TR_GRUPO_TUTORIA.PERIODO,
    -- USUARIO
    CASE
        WHEN CAT_USUARIO.SEXO = 1 THEN 'Masculino'
        WHEN CAT_USUARIO.SEXO = 2 THEN 'Femenino'
        ELSE 'No definido'
        END AS SEXO,
    CAT_USUARIO.FECHA_NACIMIENTO,
    COALESCE((CAST(DATEDIFF(DD, CAT_USUARIO.FECHA_NACIMIENTO, GETDATE()) / 365.25 AS INT)), 0) AS EDAD,
    COALESCE(CAT_ESTADO_CIVIL.NOMBRE, 'No definido') AS ESTADO_CIVL,
    COALESCE(CAT_COLONIA.NOMBRE, 'No definido') AS COLONIA,
    COALESCE(CAT_SITUACION_RESIDENCIA.NOMBRE, 'No definido') AS SITUACION_RESIDENCIA
FROM
    TR_GRUPO_TUTORIA_DETALLE
        LEFT JOIN TR_GRUPO_TUTORIA
                  ON TR_GRUPO_TUTORIA_DETALLE.FK_GRUPO = TR_GRUPO_TUTORIA.PK_GRUPO_TUTORIA
        LEFT JOIN CAT_CARRERA
                  ON TR_GRUPO_TUTORIA.FK_CARRERA = CAT_CARRERA.PK_CARRERA
        LEFT JOIN TR_AREA_ACADEMICA_CARRERA
                  ON CAT_CARRERA.PK_CARRERA = TR_AREA_ACADEMICA_CARRERA.FK_CARRERA
        LEFT JOIN CAT_AREA_ACADEMICA
                  ON TR_AREA_ACADEMICA_CARRERA.FK_AREA_ACADEMICA = CAT_AREA_ACADEMICA.PK_AREA_ACADEMICA
        LEFT JOIN CAT_USUARIO
                  ON TR_GRUPO_TUTORIA_DETALLE.FK_USUARIO = CAT_USUARIO.PK_USUARIO
        LEFT JOIN CAT_ESTADO_CIVIL
                  ON CAT_USUARIO.FK_ESTADO_CIVIL = CAT_ESTADO_CIVIL.PK_ESTADO_CIVIL
        LEFT JOIN CAT_COLONIA
                  ON CAT_USUARIO.FK_COLONIA = CAT_COLONIA.PK_COLONIA
        LEFT JOIN CAT_SITUACION_RESIDENCIA
                  ON CAT_USUARIO.FK_SITUACION_RESIDENCIA = CAT_SITUACION_RESIDENCIA.PK_SITUACION_RESIDENCIA
;


/* VISTA PARA PROCESAR REPORTES DE ENCUESTAS */
DROP VIEW IF EXISTS VW_RESPUESTA_ENCUESTA;
CREATE VIEW VW_RESPUESTA_ENCUESTA AS
SELECT
    -- DATOS DE AREA ACADEMICA
    CAT_AREA_ACADEMICA.PK_AREA_ACADEMICA,
    CAT_AREA_ACADEMICA.NOMBRE             AS AREA_ACADEMICA,
    -- DATOS DE CARRERA
    CAT_CARRERA.PK_CARRERA,
    CAT_CARRERA.NOMBRE                    AS CARRERA,
    -- DATOS DE GRUPO
    TR_GRUPO_TUTORIA.PK_GRUPO_TUTORIA,
    -- DATOS DE USUARIO
    CAT_USUARIO.PK_USUARIO,
    CAT_USUARIO.NOMBRE,
    CAT_USUARIO.PRIMER_APELLIDO,
    CAT_USUARIO.SEGUNDO_APELLIDO,
    -- DATOS DE APLICACION
    TR_APLICACION_ENCUESTA.PERIODO,
    TR_APLICACION_ENCUESTA_DETALLE.ESTADO AS ESTADO_ENCUESTA,
    -- DATOS DE ENCUESTA
    CAT_ENCUESTA.PK_ENCUESTA,
    CAT_ENCUESTA.NOMBRE                   AS ENCUESTA,
    -- DATOS DE PREGUNTAS
    CAT_PREGUNTA.PK_PREGUNTA,
    CAT_PREGUNTA.PLANTEAMIENTO,
    CAT_PREGUNTA.FK_TIPO_PREGUNTA         AS TIPO_PREGUNTA,
    -- DATOS DE RESPUESTAS
    TR_RESPUESTA_USUARIO_ENCUESTA.ORDEN,
    TR_RESPUESTA_USUARIO_ENCUESTA.RANGO,
    CAT_RESPUESTA_POSIBLE.RESPUESTA,
    TR_RESPUESTA_USUARIO_ENCUESTA.RESPUESTA_ABIERTA,
    CAT_RESPUESTA_POSIBLE.VALOR_NUMERICO
FROM TR_APLICACION_ENCUESTA_DETALLE
         -- DATOS DE ENCUESTAS Y PREGUNTAS
         LEFT JOIN TR_APLICACION_ENCUESTA
                   ON TR_APLICACION_ENCUESTA_DETALLE.FK_APLICACION_ENCUESTA
                       = TR_APLICACION_ENCUESTA.PK_APLICACION
         LEFT JOIN TR_RESPUESTA_USUARIO_ENCUESTA
                   ON TR_APLICACION_ENCUESTA_DETALLE.PK_APLICACION_ENCUESTA_DETALLE
                       = TR_RESPUESTA_USUARIO_ENCUESTA.FK_APLICACION_ENCUESTA_DETALLE
         LEFT JOIN CAT_RESPUESTA_POSIBLE
                   ON TR_RESPUESTA_USUARIO_ENCUESTA.FK_RESPUESTA_POSIBLE
                       = CAT_RESPUESTA_POSIBLE.PK_RESPUESTA_POSIBLE
         LEFT JOIN CAT_ENCUESTA
                   ON TR_APLICACION_ENCUESTA.FK_ENCUESTA = CAT_ENCUESTA.PK_ENCUESTA
         LEFT JOIN CAT_PREGUNTA
                   ON CAT_RESPUESTA_POSIBLE.FK_PREGUNTA = CAT_PREGUNTA.PK_PREGUNTA
    -- DATOS DE USUARIO Y GRUPOS
         LEFT JOIN CAT_USUARIO
                   ON TR_APLICACION_ENCUESTA_DETALLE.FK_USUARIO = CAT_USUARIO.PK_USUARIO
         JOIN TR_GRUPO_TUTORIA_DETALLE
              ON CAT_USUARIO.PK_USUARIO = TR_GRUPO_TUTORIA_DETALLE.FK_USUARIO
         JOIN TR_GRUPO_TUTORIA
              ON TR_GRUPO_TUTORIA_DETALLE.FK_GRUPO = TR_GRUPO_TUTORIA.PK_GRUPO_TUTORIA
         JOIN CAT_CARRERA
              ON TR_GRUPO_TUTORIA.FK_CARRERA = CAT_CARRERA.PK_CARRERA
         JOIN TR_AREA_ACADEMICA_CARRERA
              ON CAT_CARRERA.PK_CARRERA = TR_AREA_ACADEMICA_CARRERA.FK_CARRERA
         JOIN CAT_AREA_ACADEMICA
              ON TR_AREA_ACADEMICA_CARRERA.FK_AREA_ACADEMICA = CAT_AREA_ACADEMICA.PK_AREA_ACADEMICA
WHERE TR_RESPUESTA_USUARIO_ENCUESTA.FK_RESPUESTA_POSIBLE = CAT_RESPUESTA_POSIBLE.PK_RESPUESTA_POSIBLE
;
